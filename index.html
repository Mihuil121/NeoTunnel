<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–®–∫–∞—Ç—É–ª–∫–∞ –ó–∞–ø—Ä–µ—Ç–æ–≤</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b0616;
      --bg-alt: #130b27;
      --card: #1b1238;
      --card-soft: rgba(33, 19, 70, 0.8);
      --accent: #7b5cff;
      --accent-strong: #9f72ff;
      --accent-soft: rgba(123, 92, 255, 0.18);
      --text: #f5f2ff;
      --text-muted: #a89bd0;
      --success: #3dd2a1;
      --danger: #ff6b81;
      --warning: #ffb347;
      --border: rgba(255, 255, 255, 0.05);
      --shadow: 0 20px 60px rgba(16, 8, 37, 0.65);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      min-height: 100vh;
      font-family: 'Space Grotesk', 'Segoe UI', sans-serif;
      color: var(--text);
      background: radial-gradient(circle at 10% 20%, rgba(155, 114, 255, 0.35), transparent 55%),
                  radial-gradient(circle at 80% 0%, rgba(63, 33, 90, 0.6), transparent 60%),
                  linear-gradient(180deg, #07030f 0%, #0b0616 55%, #05020a 100%);
      display: flex; align-items: center; justify-content: center; padding: 32px;
    }

    .app { width: 1050px; max-width: 100%; display: flex; flex-direction: column; gap: 20px; position: relative; }

    .top-bar { display: flex; align-items: center; justify-content: space-between; }
    .status-chip { display:inline-flex; align-items:center; justify-content:center; padding:10px 18px; border-radius:999px; font-size:14px; font-weight:600; letter-spacing:0.02em; background: rgba(255,255,255,0.04); color: var(--text-muted); transition: background .3s,color .3s; }
    .status-chip[data-state="connected"]{ background: rgba(61,210,161,.18); color: var(--success);} 
    .status-chip[data-state="connecting"]{ background: rgba(255,179,71,.18); color: var(--warning);} 
    .status-chip[data-state="disconnected"]{ background: rgba(255,107,129,.18); color: var(--danger);} 

    .clock { display:flex; align-items:center; gap:10px; color:var(--text-muted); font-family:'JetBrains Mono', monospace; }
    .top-bar button.icon { width:44px; height:44px; border-radius:14px; border:none; background:var(--card); color:var(--text); font-size:20px; cursor:pointer; transition:transform .2s, box-shadow .2s; display:flex; align-items:center; justify-content:center; }
    .top-bar button.icon:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(123,92,255,.35); }

    .tabs { display:flex; gap:10px; background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:16px; padding:6px; width:fit-content; }
    .tab-btn { padding:10px 16px; border:none; border-radius:12px; background:transparent; color:var(--text-muted); cursor:pointer; font-weight:600; }
    .tab-btn.active { background:linear-gradient(135deg, var(--accent), var(--accent-strong)); color:#fff; box-shadow:0 6px 16px rgba(123,92,255,.35); }

    .view { display:none; }
    .view.active { display:block; }

    .card { background: var(--card); border-radius: 26px; padding: 24px; backdrop-filter: blur(25px); border: 1px solid var(--border); box-shadow: var(--shadow); position: relative; overflow: hidden; }
    .card::before { content:''; position:absolute; inset:0; background: linear-gradient(135deg, rgba(123,92,255,0.12), transparent 55%); pointer-events:none; }
    .card h2 { font-size: 20px; font-weight:600; margin-bottom: 18px; display:flex; align-items:center; gap:10px; }

    .stats-grid { display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:16px; }
    .stat-card { background: var(--card-soft); border:1px solid rgba(255,255,255,0.04); border-radius:22px; padding:18px; display:flex; flex-direction:column; gap:6px; }
    .stat-label { font-size:13px; text-transform:uppercase; letter-spacing:.08em; color:var(--text-muted); }
    .stat-value { font-size:22px; font-weight:600; }

    .power-card { display:flex; flex-direction:column; align-items:center; gap:26px; padding: 32px 24px 40px; }
    .power-orb { width:260px; height:260px; border-radius:50%; background: radial-gradient(circle at 30% 30%, rgba(123,92,255,.45), transparent 70%), radial-gradient(circle at 70% 70%, rgba(61,210,161,.25), transparent 75%), var(--card); display:flex; align-items:center; justify-content:center; position:relative; box-shadow:0 30px 60px rgba(123,92,255,.35); border:1px solid rgba(255,255,255,.08); }
    .power-orb::after { content:''; position:absolute; inset:18px; border-radius:50%; border:1px dashed rgba(255,255,255,.08); animation: rotate 18s linear infinite; }
    @keyframes rotate { to { transform: rotate(360deg); } }
    .power-button { width:130px; height:130px; border-radius:50%; border:none; background:linear-gradient(135deg, var(--accent) 0%, var(--accent-strong) 100%); color:#fff; font-size:36px; font-weight:600; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 20px 35px rgba(123,92,255,.55); transition:transform .25s, box-shadow .25s; }
    .power-button.connected { background: linear-gradient(135deg, #3dd2a1 0%, #47f5b8 100%); box-shadow: 0 25px 40px rgba(61,210,161,.4); }
    .power-button:hover { transform: translateY(-4px); }

    .current-summary { display:flex; flex-direction:column; align-items:center; gap:6px; text-align:center; }
    .current-summary .location { font-size:18px; font-weight:600; }
    .current-summary .meta { font-size:14px; color:var(--text-muted); }

    .gauge { width:100%; height:12px; background:rgba(255,255,255,.06); border-radius:999px; overflow:hidden; margin-top:18px; }
    .gauge-fill { height:100%; border-radius:999px; background:linear-gradient(135deg, var(--accent), var(--accent-strong)); width:0%; transition: width .4s ease; }
    .gauge-value { font-family:'JetBrains Mono', monospace; color:var(--text-muted); font-size:14px; margin-top:8px; }

    .pinned-details { display:flex; align-items:center; justify-content:space-between; gap:18px; padding:18px; border-radius:18px; background: rgba(255,255,255,.03); }
    .pinned-info { display:flex; align-items:center; gap:16px; }
    .flag { font-size:24px; filter: drop-shadow(0 4px 8px rgba(0,0,0,.35)); }
    .pinned-info .name { font-weight:600; font-size:16px; }
    .pinned-info .meta { font-size:13px; color:var(--text-muted); margin-top:2px; }
    .pill-button { padding:10px 20px; border-radius:16px; border:none; cursor:pointer; font-weight:600; font-size:14px; background:linear-gradient(135deg, var(--accent), var(--accent-strong)); color:#fff; transition: transform .2s, box-shadow .2s; }
    .pill-button:hover { transform: translateY(-2px); box-shadow: 0 12px 25px rgba(123,92,255,.35); }

    .server-card .subheader { margin-bottom:0; }
    .server-list { display:flex; flex-direction:column; max-height:520px; overflow-y:auto; padding-right:8px; padding-top:4px; }
    .server-list::-webkit-scrollbar { width:6px; }
    .server-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,.12); border-radius: 999px; }
    .server-list::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,.2); }
    .server-item { background: rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.04); border-radius:16px; padding:14px 16px; display:flex; align-items:center; justify-content:space-between; gap:16px; cursor:pointer; transition: all .2s; margin-bottom:8px; }
    .server-item:hover { border-color: rgba(123,92,255,.4); background: rgba(123,92,255,.08); transform: translateY(-1px); }
    .server-item.selected { border-color: var(--accent); background: rgba(123,92,255,.12); }
    .server-item.connected { border-color: rgba(61,210,161,.65); background: rgba(61,210,161,.12); }
    .server-info { display:flex; align-items:center; gap:12px; flex:1; min-width:0; }
    .server-text { display:flex; flex-direction:column; gap:4px; flex:1; min-width:0; overflow:visible; }
    .server-text .name { font-size:15px; font-weight:600; word-wrap:break-word; overflow-wrap:break-word; }
    .server-text .meta { font-size:12px; color:var(--text-muted); display:flex; align-items:center; gap:6px; flex-wrap:wrap; word-wrap:break-word; overflow-wrap:break-word; }
    .server-actions { display:flex; align-items:center; gap:8px; flex-shrink:0; }
    .circle-btn { width:36px; height:36px; border-radius:50%; border:none; background: rgba(255,255,255,.06); color:var(--text); font-size:14px; cursor:pointer; transition: all .2s; display:flex; align-items:center; justify-content:center; }
    .circle-btn:hover { background: rgba(123,92,255,.25); transform: scale(1.05); }
    .server-actions .pill-button { padding:8px 16px; font-size:13px; white-space:nowrap; }
    .server-actions .pill-button.disconnect { background: rgba(255, 107, 129, .2); color: var(--danger); border:1px solid rgba(255,107,129,0.3); }
    .server-actions .pill-button.delete { background: rgba(255, 107, 129, .15); color: var(--danger); font-size:11px; padding:6px 10px; border:1px solid rgba(255,107,129,0.2); }

    .notification { position: fixed; top: 26px; right: 26px; min-width: 260px; padding: 16px 20px; border-radius: 18px; background: rgba(27, 18, 56, .95); border: 1px solid rgba(255,255,255,.08); color: var(--text); font-weight: 500; letter-spacing: .01em; box-shadow: 0 18px 35px rgba(9,4,25,.45); transform: translateY(-30px); opacity: 0; pointer-events: none; transition: opacity .25s, transform .25s; }
    .notification.show { opacity: 1; transform: translateY(0); }
    .notification.success { border-color: rgba(61,210,161,.6); }
    .notification.error { border-color: rgba(255,107,129,.6); }

    .modal-overlay { backdrop-filter: blur(8px); }

    @media (max-width: 1080px) { body { padding: 24px; } }
    @media (max-width: 640px) { .stats-grid { grid-template-columns: repeat(2, minmax(0,1fr)); } .power-orb { width:220px; height:220px; } .power-button { width:110px; height:110px; font-size:32px; } }
  </style>
</head>
<body>
  <div class="app">
    <div class="top-bar">
      <div class="status-chip" id="status-chip" data-state="disconnected">–û—Ç–∫–ª—é—á–µ–Ω–æ</div>
      <div class="clock"><span>–í—Ä–µ–º—è</span><span id="clock">--:--:--</span></div>
      <button class="icon" id="whoer-btn" title="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å IP">üåê</button>
    </div>

    <div class="tabs">
      <button class="tab-btn active" id="tab-power">–ü–∏—Ç–∞–Ω–∏–µ</button>
      <button class="tab-btn" id="tab-servers">–°–µ—Ä–≤–µ—Ä—ã</button>
      <button class="tab-btn" id="tab-speed">–°–∫–æ—Ä–æ—Å—Ç—å</button>
    </div>

    <!-- View: Power -->
    <section class="view active" id="view-power">
      <div class="card power-card">
        <div class="power-orb"><button class="power-button" id="power-button">‚èª</button></div>
        <div class="current-summary">
          <div class="location" id="current-server-name">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä</div>
          <div class="meta" id="current-server-meta">–°—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –æ–±–Ω–æ–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
        </div>
        <div class="pinned-details" id="pinned-details"><div class="empty">–ó–∞–∫—Ä–µ–ø–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∫ –Ω–µ–º—É</div></div>
      </div>
    </section>

    <!-- View: Servers -->
    <section class="view" id="view-servers">
      <div class="card server-card">
        <div class="subheader" style="margin-bottom:16px;">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
            <h2 style="margin:0; font-size:18px;">–°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤</h2>
            <span id="server-count" style="color:var(--text-muted); font-size:14px;">0 –¥–æ—Å—Ç—É–ø–Ω–æ</span>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="pill-button" id="add-config-btn" style="padding:10px 18px; font-size:13px; flex:1; min-width:120px;">+ –î–æ–±–∞–≤–∏—Ç—å</button>
            <button class="pill-button" id="update-subscriptions-btn" style="padding:10px 18px; font-size:13px; flex:1; min-width:140px; background:linear-gradient(135deg, var(--accent), var(--accent-strong));">üîÑ –ü–æ–¥–ø–∏—Å–∫–∏</button>
            <button class="pill-button" id="test-all-btn" style="padding:10px 18px; font-size:13px; flex:1; min-width:120px; background:rgba(255,179,71,0.2); color:var(--warning); border:1px solid rgba(255,179,71,0.3);">‚ö° –¢–µ—Å—Ç</button>
            <button class="pill-button" id="blocked-test-btn" style="padding:10px 18px; font-size:13px; flex:1; min-width:150px; background:rgba(61,210,161,0.15); color:var(--success); border:1px solid rgba(61,210,161,0.4);">üõ° –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏</button>
          </div>
          <div style="display:flex; gap:8px; margin-top:8px;">
            <button class="pill-button" id="remove-duplicates-btn" style="padding:8px 16px; font-size:12px; flex:1; background:rgba(255,107,129,0.15); color:var(--danger); border:1px solid rgba(255,107,129,0.2);">üóë –î—É–±–ª–∏–∫–∞—Ç—ã</button>
            <button class="pill-button" id="clear-all-btn" style="padding:8px 16px; font-size:12px; flex:1; background:rgba(255,107,129,0.15); color:var(--danger); border:1px solid rgba(255,107,129,0.2);">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>
        </div>
        <div class="server-list" id="server-list"></div>
      </div>
    </section>

    <!-- View: Speed -->
    <section class="view" id="view-speed">
      <div class="card">
        <h2>–°–∫–æ—Ä–æ—Å—Ç—å VPN</h2>
        <div class="stats-grid">
          <div class="stat-card"><span class="stat-label">Download</span><span class="stat-value" id="stat-download">0.0 Mb/s</span></div>
          <div class="stat-card"><span class="stat-label">Upload</span><span class="stat-value" id="stat-upload">0.0 Mb/s</span></div>
          <div class="stat-card"><span class="stat-label">–ü–∏–Ω–≥</span><span class="stat-value" id="stat-ping">‚Äî ms</span></div>
        </div>
        <div class="gauge"><div class="gauge-fill" id="speed-gauge"></div></div>
        <div class="gauge-value" id="speed-value">0.00 Mb/s</div>
      </div>
    </section>
  </div>

    <div class="notification" id="notification"></div>

    <!-- Modal –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞ -->
    <div class="modal-overlay" id="config-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:1000; align-items:center; justify-content:center;">
      <div class="card" style="max-width:600px; width:90%; max-height:80vh; overflow-y:auto;">
        <h2 style="margin-bottom:20px;">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥</h2>
        
        <!-- –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Å–ø–æ—Å–æ–±–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
        <div style="margin-bottom:20px;">
          <label style="display:block; margin-bottom:8px; font-size:14px; color:var(--text-muted);">–°–ø–æ—Å–æ–± –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:</label>
          <select id="add-method-select" style="width:100%; padding:12px; border-radius:12px; background:var(--card-soft); border:1px solid var(--border); color:var(--text); font-size:14px; cursor:pointer;">
            <option value="clipboard">üìã –ò–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞</option>
            <option value="url">üåê –ü–æ —Å—Å—ã–ª–∫–µ (–æ–¥–Ω–∞ —Å—Å—ã–ª–∫–∞)</option>
            <option value="subscription">üì• –ü–æ–¥–ø–∏—Å–∫–∞ (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Å—ã–ª–∫—É)</option>
          </select>
        </div>

        <!-- –†–µ–∂–∏–º: –ò–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞ -->
        <div id="mode-clipboard" style="display:flex; flex-direction:column; gap:16px;">
          <div>
            <label style="display:block; margin-bottom:8px; font-size:14px; color:var(--text-muted);">–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥(–∏) –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞ (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ, –∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):</label>
            <textarea id="config-input" placeholder="vless://... –∏–ª–∏ vmess://... –∏–ª–∏ trojan://... –∏–ª–∏ ss://...&#10;&#10;–ú–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–Ω—Ñ–∏–≥–æ–≤, –∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏" style="width:100%; min-height:120px; padding:12px; border-radius:12px; background:var(--card-soft); border:1px solid var(--border); color:var(--text); font-family:'JetBrains Mono', monospace; font-size:13px; resize:vertical;"></textarea>
          </div>
          <div style="display:flex; gap:10px;">
            <button class="pill-button" id="paste-btn" style="flex:1;">üìã –í—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞</button>
            <button class="pill-button" id="add-btn" style="flex:1; background:linear-gradient(135deg, var(--success), #47f5b8);">‚úì –î–æ–±–∞–≤–∏—Ç—å</button>
          </div>
          <label style="display:flex; align-items:center; gap:8px; font-size:13px; color:var(--text-muted); cursor:pointer;">
            <input type="checkbox" id="test-on-add" style="width:18px; height:18px; cursor:pointer;">
            <span>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º</span>
          </label>
        </div>

        <!-- –†–µ–∂–∏–º: –ü–æ —Å—Å—ã–ª–∫–µ -->
        <div id="mode-url" style="display:none; flex-direction:column; gap:16px;">
          <div>
            <label style="display:block; margin-bottom:8px; font-size:14px; color:var(--text-muted);">URL –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥–æ–≤:</label>
            <input type="text" id="config-url-input" value="https://raw.githubusercontent.com/STR97/STRUGOV/refs/heads/main/STR.BYPASS" placeholder="https://raw.githubusercontent.com/..." style="width:100%; padding:12px; border-radius:12px; background:var(--card-soft); border:1px solid var(--border); color:var(--text); font-family:'JetBrains Mono', monospace; font-size:13px;">
            <div style="margin-top:8px; font-size:12px; color:var(--text-muted);">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Å—Å—ã–ª–∫–∏ –Ω–∞ raw —Ñ–∞–π–ª—ã (GitHub, GitLab –∏ —Ç.–¥.)</div>
          </div>
          <button class="pill-button" id="load-url-btn" style="background:linear-gradient(135deg, var(--accent), var(--accent-strong));">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥–∏</button>
          <label style="display:flex; align-items:center; gap:8px; font-size:13px; color:var(--text-muted); cursor:pointer;">
            <input type="checkbox" id="test-on-load" style="width:18px; height:18px; cursor:pointer;">
            <span>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥–∏ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É</span>
          </label>
          <div id="url-loading" style="display:none; padding:12px; border-radius:12px; background:rgba(123,92,255,0.15); border:1px solid rgba(123,92,255,0.3); color:var(--accent); font-size:13px; text-align:center;">
            ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥–æ–≤...
          </div>
          <div id="url-result" style="display:none; padding:12px; border-radius:12px; font-size:13px;"></div>
        </div>

        <!-- –†–µ–∂–∏–º: –ü–æ–¥–ø–∏—Å–∫–∞ -->
        <div id="mode-subscription" style="display:none; flex-direction:column; gap:16px;">
          <div>
            <label style="display:block; margin-bottom:8px; font-size:14px; color:var(--text-muted);">URL –ø–æ–¥–ø–∏—Å–∫–∏ (–±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω):</label>
            <input type="text" id="subscription-url-input" value="https://raw.githubusercontent.com/STR97/STRUGOV/refs/heads/main/STR.BYPASS" placeholder="https://raw.githubusercontent.com/..." style="width:100%; padding:12px; border-radius:12px; background:var(--card-soft); border:1px solid var(--border); color:var(--text); font-family:'JetBrains Mono', monospace; font-size:13px;">
            <div style="margin-top:8px; font-size:12px; color:var(--text-muted);">–°—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</div>
          </div>
          <button class="pill-button" id="add-subscription-btn" style="background:linear-gradient(135deg, var(--accent), var(--accent-strong));">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
          <label style="display:flex; align-items:center; gap:8px; font-size:13px; color:var(--text-muted); cursor:pointer;">
            <input type="checkbox" id="test-on-subscription" style="width:18px; height:18px; cursor:pointer;">
            <span>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥–∏ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É</span>
          </label>
          <div id="subscription-loading" style="display:none; padding:12px; border-radius:12px; background:rgba(123,92,255,0.15); border:1px solid rgba(123,92,255,0.3); color:var(--accent); font-size:13px; text-align:center;">
            ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥–æ–≤...
          </div>
          <div id="subscription-result" style="display:none; padding:12px; border-radius:12px; font-size:13px;"></div>
        </div>

        <div id="config-error" style="display:none; padding:12px; border-radius:12px; background:rgba(255,107,129,0.15); border:1px solid rgba(255,107,129,0.3); color:var(--danger); font-size:13px; margin-top:16px;"></div>
        <button class="pill-button" id="cancel-btn" style="background:rgba(255,255,255,0.08); margin-top:16px;">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>

  <script>
    const ui = {
      statusChip: document.getElementById('status-chip'),
      clock: document.getElementById('clock'),
      whoer: document.getElementById('whoer-btn'),
      powerButton: document.getElementById('power-button'),
      serverList: document.getElementById('server-list'),
      serverCount: document.getElementById('server-count'),
      currentName: document.getElementById('current-server-name'),
      currentMeta: document.getElementById('current-server-meta'),
      statDownload: document.getElementById('stat-download'),
      statUpload: document.getElementById('stat-upload'),
      statPing: document.getElementById('stat-ping'),
      speedGauge: document.getElementById('speed-gauge'),
      speedValue: document.getElementById('speed-value'),
      pinnedDetails: document.getElementById('pinned-details'),
      notification: document.getElementById('notification'),
      tabs: {
        power: document.getElementById('tab-power'),
        servers: document.getElementById('tab-servers'),
        speed: document.getElementById('tab-speed')
      },
      views: {
        power: document.getElementById('view-power'),
        servers: document.getElementById('view-servers'),
        speed: document.getElementById('view-speed')
      }
    };

    function showTab(tab) {
      Object.values(ui.tabs).forEach(b => b.classList.remove('active'));
      Object.values(ui.views).forEach(v => v.classList.remove('active'));
      ui.tabs[tab].classList.add('active');
      ui.views[tab].classList.add('active');
    }

    ui.tabs.power.addEventListener('click', () => showTab('power'));
    ui.tabs.servers.addEventListener('click', () => showTab('servers'));
    ui.tabs.speed.addEventListener('click', () => showTab('speed'));

    let serversCache = {};
    let selectedId = null;
    let pinnedId = null;
    let connectedId = null;
    let isConnected = false;
    let isBusy = false;
    let connectedAt = null;
    let durationTimer = null;

    function showNotification(message, type = 'success') {
      ui.notification.textContent = message;
      ui.notification.className = `notification ${type}`;
      ui.notification.classList.add('show');
      setTimeout(() => ui.notification.classList.remove('show'), 3000);
    }

    function formatDuration(ms) {
      const totalSeconds = Math.max(0, Math.floor(ms / 1000));
      const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
      const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
      const seconds = String(totalSeconds % 60).padStart(2, '0');
      return `${hours}:${minutes}:${seconds}`;
    }

    function updateDuration() {
      if (!connectedAt) {
        ui.clock.textContent = '00:00:00';
        return;
      }
      ui.clock.textContent = formatDuration(Date.now() - connectedAt);
    }

    function startDurationTimer() {
      connectedAt = Date.now();
      updateDuration();
      clearInterval(durationTimer);
      durationTimer = setInterval(updateDuration, 1000);
    }

    function stopDurationTimer() {
      clearInterval(durationTimer);
      durationTimer = null;
      connectedAt = null;
      updateDuration();
    }

    updateDuration();

    function resetSpeed() {
      ui.statDownload.textContent = '0.0 Mb/s';
      ui.statUpload.textContent = '0.0 Mb/s';
      ui.speedValue.textContent = '0.00 Mb/s';
      ui.speedGauge.style.width = '0%';
    }

    function updateSpeed(data) {
      if (!isConnected) return;
      const downMbps = (data.downBps * 8 / 1e6) || 0;
      const upMbps = (data.upBps * 8 / 1e6) || 0;
      ui.statDownload.textContent = `${downMbps.toFixed(2)} Mb/s`;
      ui.statUpload.textContent = `${upMbps.toFixed(2)} Mb/s`;
      ui.speedValue.textContent = `${downMbps.toFixed(2)} Mb/s`;
      ui.speedGauge.style.width = `${Math.min(100, downMbps * 2)}%`;
    }

    if (window.vpn.onSpeedUpdate) { window.vpn.onSpeedUpdate(updateSpeed); }

    function updateStatus(state, text) { ui.statusChip.dataset.state = state; ui.statusChip.textContent = text; }

    function setSelected(id) {
      selectedId = id;
      document.querySelectorAll('.server-item').forEach(item => item.classList.toggle('selected', item.dataset.id === id));
      if (id && serversCache[id]) {
        const server = serversCache[id];
        ui.currentName.textContent = `${server.flag} ${server.name}`;
        ui.currentMeta.textContent = server.speed;
      } else {
        ui.currentName.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä';
        ui.currentMeta.textContent = '–°—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –æ–±–Ω–æ–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
      }
    }

    function updateServerButtons() {
      document.querySelectorAll('.server-item').forEach(item => {
        const id = item.dataset.id; const btn = item.querySelector('[data-action="connect"]'); if (!btn) return;
        if (connectedId === id) { btn.textContent = '–û—Ç–∫–ª—é—á–∏—Ç—å'; btn.classList.add('disconnect'); item.classList.add('connected'); }
        else { btn.textContent = '–ü–æ–¥–∫–ª—é—á–∏—Ç—å'; btn.classList.remove('disconnect'); item.classList.remove('connected'); }
      });
    }

    function renderPinned() {
      const wrap = ui.pinnedDetails; wrap.innerHTML = '';
      if (!pinnedId || !serversCache[pinnedId]) { wrap.innerHTML = '<div class="empty">–ó–∞–∫—Ä–µ–ø–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∫ –Ω–µ–º—É</div>'; return; }
      const s = serversCache[pinnedId];
      const info = document.createElement('div'); info.className = 'pinned-info';
      info.innerHTML = `<span class="flag">${s.flag}</span><div><div class="name">${s.name}</div><div class="meta">${s.speed}</div></div>`;
      const actions = document.createElement('div'); actions.className = 'server-actions';
      const connectBtn = document.createElement('button'); connectBtn.className = 'pill-button'; connectBtn.textContent = connectedId === pinnedId ? '–û—Ç–∫–ª—é—á–∏—Ç—å' : '–ü–æ–¥–∫–ª—é—á–∏—Ç—å';
      connectBtn.addEventListener('click', async (e) => { e.stopPropagation(); if (connectedId === pinnedId) await disconnect(); else await connectTo(pinnedId); });
      actions.appendChild(connectBtn); wrap.appendChild(info); wrap.appendChild(actions);
    }

    async function loadServers(testResults = null) {
      try {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º configUrl –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –¥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        const selectedConfigUrl = selectedId && serversCache[selectedId] ? serversCache[selectedId].configUrl : null;
        const pinnedConfigUrl = pinnedId && serversCache[pinnedId] ? serversCache[pinnedId].configUrl : null;
        
        let servers;
        if (testResults && Array.isArray(testResults) && testResults.length > 0) {
          // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
          servers = await window.vpn.getServers(false);
          // –ü–µ—Ä–µ—Å–æ—Ä—Ç–∏—Ä—É–µ–º —Å–µ—Ä–≤–µ—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤
          const testMap = new Map(testResults.map(r => [r.configUrl, r]));
          const sortedIds = Object.keys(servers).sort((a, b) => {
            const testA = testMap.get(servers[a].configUrl);
            const testB = testMap.get(servers[b].configUrl);
            if (testA && testB) {
              if (testA.success && !testB.success) return -1;
              if (!testA.success && testB.success) return 1;
              if (testA.success && testB.success) {
                return (testA.latency || Infinity) - (testB.latency || Infinity);
              }
            }
            return 0;
          });
          const sortedServers = {};
          sortedIds.forEach((id, index) => {
            const server = servers[id];
            server.testResult = testMap.get(server.configUrl);
            sortedServers[index] = server;
          });
          servers = sortedServers;
        } else {
          servers = await window.vpn.getServers(false);
        }
        serversCache = servers;
        ui.serverCount.textContent = `${Object.keys(servers).length} –¥–æ—Å—Ç—É–ø–Ω–æ`;
        ui.serverList.innerHTML = '';
        
        if (Object.keys(servers).length === 0) {
          ui.serverList.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-muted);"><div style="font-size:48px; margin-bottom:16px;">üìã</div><div style="font-size:16px; margin-bottom:8px;">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤</div><div style="font-size:14px;">–ù–∞–∂–º–∏—Ç–µ "+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥" —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π —Å–µ—Ä–≤–µ—Ä</div></div>';
          setSelected(null);
        } else {
          Object.entries(servers).forEach(([id, s]) => {
            const item = document.createElement('div'); item.className = 'server-item'; item.dataset.id = id;
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –º–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            let metaText = '';
            if (s.testResult) {
              if (s.testResult.success) {
                metaText = s.testResult.latency ? `‚úÖ ${s.testResult.latency}ms` : '‚úÖ –¥–æ—Å—Ç—É–ø–µ–Ω';
              } else {
                metaText = '‚ùå –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
                item.style.opacity = '0.65';
              }
            } else {
              metaText = s.speed || '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π';
            }
            
            // –û—á–∏—â–∞–µ–º –∏–º—è –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
            const cleanName = s.name.replace(/[üîûüëæ]/g, '').trim();
            
            item.innerHTML = `
              <div class="server-info">
                <span class="flag" style="font-size:20px;">${s.flag}</span>
                <div class="server-text">
                  <div class="name">${cleanName}</div>
                  <div class="meta">${metaText}</div>
                </div>
              </div>
              <div class="server-actions">
                <button class="circle-btn" data-action="pin" title="–ó–∞–∫—Ä–µ–ø–∏—Ç—å">üìå</button>
                <button class="circle-btn delete" data-action="delete" title="–£–¥–∞–ª–∏—Ç—å" style="background:rgba(255,107,129,0.15);">üóë</button>
                <button class="pill-button" data-action="connect">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
              </div>
            `;
            ui.serverList.appendChild(item);
          });
          
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –ø–æ configUrl
          if (pinnedConfigUrl) {
            for (const [id, server] of Object.entries(servers)) {
              if (server.configUrl === pinnedConfigUrl) {
                pinnedId = id;
                break;
              }
            }
            // –ï—Å–ª–∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º pinnedId
            if (pinnedId && !servers[pinnedId]) {
              pinnedId = null;
            }
          }
          
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –ø–æ configUrl
          let restoredSelectedId = null;
          if (selectedConfigUrl) {
            // –ò—â–µ–º —Å–µ—Ä–≤–µ—Ä —Å —Ç–∞–∫–∏–º –∂–µ configUrl –≤ –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ
            for (const [id, server] of Object.entries(servers)) {
              if (server.configUrl === selectedConfigUrl) {
                restoredSelectedId = id;
                break;
              }
            }
          }
          
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä: —Å–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π, –ø–æ—Ç–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π, –ø–æ—Ç–æ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π
          if (pinnedId && servers[pinnedId]) {
            setSelected(pinnedId);
          } else if (restoredSelectedId && servers[restoredSelectedId]) {
            setSelected(restoredSelectedId);
          } else {
            // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (–ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ —Å —É—Å–ø–µ—à–Ω—ã–º —Ç–µ—Å—Ç–æ–º)
            const serverIds = Object.keys(servers);
            const availableServer = serverIds.find(id => {
              const server = servers[id];
              return !server.testResult || server.testResult.success;
            });
            setSelected(availableServer || serverIds[0] || null);
          }
        }
        
        updateServerButtons(); renderPinned(); updateStatus(isConnected ? 'connected' : 'disconnected', isConnected ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ' : '–û—Ç–∫–ª—é—á–µ–Ω–æ');
      } catch (e) { updateStatus('disconnected', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'); showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Ä–≤–µ—Ä—ã', 'error'); }
    }

    ui.serverList && ui.serverList.addEventListener('click', async (event) => {
      const item = event.target.closest('.server-item'); if (!item) return;
      const id = item.dataset.id; const actionEl = event.target.closest('[data-action]'); if (!actionEl) { setSelected(id); return; }
      const action = actionEl.dataset.action;
      if (action === 'pin') {
        try { await window.vpn.pinServer(id); pinnedId = id; renderPinned(); showNotification('–°–µ—Ä–≤–µ—Ä –∑–∞–∫—Ä–µ–ø–ª—ë–Ω'); } catch { showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫—Ä–µ–ø–∏—Ç—å —Å–µ—Ä–≤–µ—Ä', 'error'); }
      } else if (action === 'connect') {
        if (connectedId === id) await disconnect(); else await connectTo(id);
      }
    });

    async function connectTo(id) {
      if (!id || !serversCache[id] || isBusy) { 
        if (!id) showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä', 'error'); 
        return; 
      }
      const server = serversCache[id];
      if (!server || !server.configUrl) { 
        showNotification('–û—à–∏–±–∫–∞: —Å–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error'); 
        return; 
      }
      
      isBusy = true; 
      setSelected(id); 
      updateStatus('connecting', '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...'); 
      ui.powerButton.classList.add('connecting');
      try { 
        // –ü–µ—Ä–µ–¥–∞–µ–º configUrl –Ω–∞–ø—Ä—è–º—É—é –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
        const res = await window.vpn.connect(server.configUrl); 
        connectedId = id; 
        isConnected = true; 
        updateStatus('connected', `–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ ${res.server.name}`); 
        ui.powerButton.classList.add('connected'); 
        showNotification(`–£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ${res.server.name}`); 
        updateServerButtons(); 
        startDurationTimer(); 
      }
      catch { 
        showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è', 'error'); 
        updateStatus('disconnected', '–û—Ç–∫–ª—é—á–µ–Ω–æ'); 
        stopDurationTimer(); 
      }
      finally { 
        ui.powerButton.classList.remove('connecting'); 
        isBusy = false; 
      }
    }

    async function disconnect() {
      if (!isConnected || isBusy) return; isBusy = true; updateStatus('connecting', '–û—Ç–∫–ª—é—á–µ–Ω–∏–µ...');
      try { await window.vpn.disconnect(); connectedId = null; isConnected = false; resetSpeed(); ui.powerButton.classList.remove('connected'); updateStatus('disconnected', '–û—Ç–∫–ª—é—á–µ–Ω–æ'); showNotification('VPN –æ—Ç–∫–ª—é—á—ë–Ω'); updateServerButtons(); stopDurationTimer(); }
      catch { showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏', 'error'); }
      finally { isBusy = false; }
    }

    async function smartPowerClick() {
      if (isConnected) {
        await disconnect();
        return;
      }

      // –ï—Å–ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω –∏–ª–∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω —Å–µ—Ä–≤–µ—Ä ‚Äì –ø—Ä–æ—Å—Ç–æ –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –Ω–µ–º—É
      const directId = selectedId || pinnedId;
      if (directId && serversCache[directId]) {
        await connectTo(directId);
        return;
      }

      // –ò–Ω–∞—á–µ: —É–º–Ω—ã–π –ø–æ–¥–±–æ—Ä –ª—É—á—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
      if (isBusy) return;
      isBusy = true;
      updateStatus('connecting', '–ü–æ–¥–±–æ—Ä –ª—É—á—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞...');
      ui.powerButton.classList.add('connecting');

      try {
        const totalServers = Object.keys(serversCache).length;
        if (totalServers === 0) {
          await loadServers();
        }

        const results = await window.vpn.testAllConfigs();
        await loadServers(results);

        // –ë–µ—Ä–µ–º –ª—É—á—à–∏–π —Å–µ—Ä–≤–µ—Ä –∏–∑ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
        const ids = Object.keys(serversCache);
        const bestId = ids.find(id => {
          const s = serversCache[id];
          return s.testResult && s.testResult.success;
        }) || ids[0];

        if (!bestId) {
          showNotification('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞', 'error');
          updateStatus('disconnected', '–û—Ç–∫–ª—é—á–µ–Ω–æ');
          return;
        }

        setSelected(bestId);
        isBusy = false; // connectTo —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç isBusy
        await connectTo(bestId);

        // –ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å—Ä–∞–∑—É –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Å–∞–π—Ç–∞–º
        try {
          const blocked = await window.vpn.testBlockedSites();
          if (blocked && blocked.success) {
            const summary = blocked.results.map(r => `${r.success ? '‚úÖ' : '‚ùå'} ${r.name}`).join(', ');
            const type = blocked.reachable === blocked.results.length ? 'success' : 'error';
            showNotification(`–î–æ—Å—Ç—É–ø: ${summary}`, type);
          }
        } catch (_) {}
      } catch (e) {
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–±–æ—Ä–µ —Å–µ—Ä–≤–µ—Ä–∞', 'error');
        updateStatus('disconnected', '–û—Ç–∫–ª—é—á–µ–Ω–æ');
      } finally {
        ui.powerButton.classList.remove('connecting');
        isBusy = false;
      }
    }

    ui.powerButton.addEventListener('click', smartPowerClick);
    ui.whoer.addEventListener('click', () => { window.vpn.openWhoer(); showNotification('–û—Ç–∫—Ä—ã–≤–∞—é whoer –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ IP'); });

    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞
    const modal = document.getElementById('config-modal');
    const configInput = document.getElementById('config-input');
    const pasteBtn = document.getElementById('paste-btn');
    const addBtn = document.getElementById('add-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const configError = document.getElementById('config-error');
    const addConfigBtn = document.getElementById('add-config-btn');
    const methodSelect = document.getElementById('add-method-select');
    const modeClipboard = document.getElementById('mode-clipboard');
    const modeUrl = document.getElementById('mode-url');
    const modeSubscription = document.getElementById('mode-subscription');
    const urlInput = document.getElementById('config-url-input');
    const subscriptionUrlInput = document.getElementById('subscription-url-input');
    const loadUrlBtn = document.getElementById('load-url-btn');
    const addSubscriptionBtn = document.getElementById('add-subscription-btn');
    const urlLoading = document.getElementById('url-loading');
    const urlResult = document.getElementById('url-result');
    const subscriptionLoading = document.getElementById('subscription-loading');
    const subscriptionResult = document.getElementById('subscription-result');
    const testOnAdd = document.getElementById('test-on-add');
    const testOnLoad = document.getElementById('test-on-load');
    const testOnSubscription = document.getElementById('test-on-subscription');

    function switchAddMode(mode) {
      modeClipboard.style.display = mode === 'clipboard' ? 'flex' : 'none';
      modeUrl.style.display = mode === 'url' ? 'flex' : 'none';
      modeSubscription.style.display = mode === 'subscription' ? 'flex' : 'none';
      configError.style.display = 'none';
      urlResult.style.display = 'none';
      subscriptionResult.style.display = 'none';
    }

    methodSelect.addEventListener('change', (e) => {
      switchAddMode(e.target.value);
    });

    function showModal() {
      modal.style.display = 'flex';
      configInput.value = '';
      urlInput.value = subscriptionUrlInput.value = 'https://raw.githubusercontent.com/STR97/STRUGOV/refs/heads/main/STR.BYPASS';
      configError.style.display = 'none';
      urlLoading.style.display = 'none';
      subscriptionLoading.style.display = 'none';
      urlResult.style.display = 'none';
      subscriptionResult.style.display = 'none';
      methodSelect.value = 'clipboard';
      switchAddMode('clipboard');
      configInput.focus();
    }

    function hideModal() {
      modal.style.display = 'none';
      configError.style.display = 'none';
    }

    addConfigBtn.addEventListener('click', showModal);
    cancelBtn.addEventListener('click', hideModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) hideModal(); });

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞(–æ–≤) –∏–∑ –±—É—Ñ–µ—Ä–∞ —Å —Ç–µ—Å—Ç–æ–º
    addBtn.addEventListener('click', async () => {
      const configText = configInput.value.trim();
      if (!configText) {
        configError.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥(–∏)';
        configError.style.display = 'block';
        return;
      }

      const shouldTest = testOnAdd.checked;
      addBtn.disabled = true;
      addBtn.textContent = shouldTest ? '‚è≥ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...' : '‚è≥ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';
      configError.style.display = 'none';

      try {
        const result = await window.vpn.addConfigsFromText(configText, shouldTest);
        
        addBtn.disabled = false;
        addBtn.textContent = '‚úì –î–æ–±–∞–≤–∏—Ç—å';
        
        if (result.success) {
          if (result.added > 0) {
            showNotification(result.message || `–î–æ–±–∞–≤–ª–µ–Ω–æ ${result.added} –∫–æ–Ω—Ñ–∏–≥–æ–≤`);
            hideModal();
            await loadServers(shouldTest ? result.testResults : null);
          } else {
            configError.textContent = '–í—Å–µ –∫–æ–Ω—Ñ–∏–≥–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã';
            configError.style.display = 'block';
          }
        } else {
          configError.textContent = result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏';
          configError.style.display = 'block';
        }
      } catch (e) {
        addBtn.disabled = false;
        addBtn.textContent = '‚úì –î–æ–±–∞–≤–∏—Ç—å';
        configError.textContent = `–û—à–∏–±–∫–∞: ${e.message}`;
        configError.style.display = 'block';
      }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥–æ–≤ –ø–æ URL
    loadUrlBtn.addEventListener('click', async () => {
      const url = urlInput.value.trim();
      if (!url) {
        configError.textContent = '–í–≤–µ–¥–∏—Ç–µ URL';
        configError.style.display = 'block';
        return;
      }

      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        configError.textContent = 'URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http:// –∏–ª–∏ https://';
        configError.style.display = 'block';
        return;
      }

      urlLoading.style.display = 'block';
      urlResult.style.display = 'none';
      configError.style.display = 'none';
      loadUrlBtn.disabled = true;
      const shouldTest = testOnLoad.checked;

      try {
        const result = await window.vpn.loadConfigsFromUrl(url, shouldTest);
        
        urlLoading.style.display = 'none';
        loadUrlBtn.disabled = false;

        if (result.success) {
          urlResult.style.display = 'block';
          urlResult.style.background = 'rgba(61,210,161,0.15)';
          urlResult.style.border = '1px solid rgba(61,210,161,0.3)';
          urlResult.style.color = 'var(--success)';
          urlResult.innerHTML = `
            <div style="font-weight:600; margin-bottom:8px;">‚úì –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!</div>
            <div>–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ: ${result.total}</div>
            <div>–í–∞–ª–∏–¥–Ω—ã—Ö: ${result.loaded}</div>
            <div>–î–æ–±–∞–≤–ª–µ–Ω–æ: ${result.added}</div>
            <div>–ü—Ä–æ–ø—É—â–µ–Ω–æ (–¥—É–±–ª–∏–∫–∞—Ç—ã): ${result.skipped}</div>
            <div>–ù–µ–≤–∞–ª–∏–¥–Ω—ã—Ö: ${result.invalid}</div>
            ${shouldTest && result.testResults ? `<div style="margin-top:8px; font-size:12px;">–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${result.testResults.filter(r => r.success).length} –¥–æ—Å—Ç—É–ø–Ω—ã</div>` : ''}
          `;
          
          if (result.added > 0) {
            setTimeout(async () => {
              await loadServers(shouldTest ? result.testResults : null);
              hideModal();
              showNotification(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${result.added} –∫–æ–Ω—Ñ–∏–≥–æ–≤`);
            }, 1500);
          } else {
            showNotification('–ù–æ–≤—ã—Ö –∫–æ–Ω—Ñ–∏–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
          }
        } else {
          configError.textContent = result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ';
          configError.style.display = 'block';
        }
      } catch (e) {
        urlLoading.style.display = 'none';
        loadUrlBtn.disabled = false;
        configError.textContent = `–û—à–∏–±–∫–∞: ${e.message}`;
        configError.style.display = 'block';
      }
    });

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
    addSubscriptionBtn.addEventListener('click', async () => {
      const url = subscriptionUrlInput.value.trim();
      if (!url) {
        configError.textContent = '–í–≤–µ–¥–∏—Ç–µ URL';
        configError.style.display = 'block';
        return;
      }

      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        configError.textContent = 'URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http:// –∏–ª–∏ https://';
        configError.style.display = 'block';
        return;
      }

      subscriptionLoading.style.display = 'block';
      subscriptionResult.style.display = 'none';
      configError.style.display = 'none';
      addSubscriptionBtn.disabled = true;
      const shouldTest = testOnSubscription.checked;

      try {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
        await window.vpn.addSubscription(url);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥–∏
        const result = await window.vpn.loadConfigsFromUrl(url, shouldTest);
        
        subscriptionLoading.style.display = 'none';
        addSubscriptionBtn.disabled = false;

        if (result.success) {
          subscriptionResult.style.display = 'block';
          subscriptionResult.style.background = 'rgba(61,210,161,0.15)';
          subscriptionResult.style.border = '1px solid rgba(61,210,161,0.3)';
          subscriptionResult.style.color = 'var(--success)';
          subscriptionResult.innerHTML = `
            <div style="font-weight:600; margin-bottom:8px;">‚úì –ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!</div>
            <div>–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ: ${result.total}</div>
            <div>–í–∞–ª–∏–¥–Ω—ã—Ö: ${result.loaded}</div>
            <div>–î–æ–±–∞–≤–ª–µ–Ω–æ: ${result.added}</div>
            <div>–ü—Ä–æ–ø—É—â–µ–Ω–æ (–¥—É–±–ª–∏–∫–∞—Ç—ã): ${result.skipped}</div>
            <div>–ù–µ–≤–∞–ª–∏–¥–Ω—ã—Ö: ${result.invalid}</div>
            ${shouldTest && result.testResults ? `<div style="margin-top:8px; font-size:12px;">–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${result.testResults.filter(r => r.success).length} –¥–æ—Å—Ç—É–ø–Ω—ã</div>` : ''}
          `;
          
          if (result.added > 0) {
            setTimeout(async () => {
              await loadServers(shouldTest ? result.testResults : null);
              hideModal();
              showNotification(`–ü–æ–¥–ø–∏—Å–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞. –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${result.added} –∫–æ–Ω—Ñ–∏–≥–æ–≤`);
            }, 1500);
          } else {
            showNotification('–ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞, –Ω–æ –Ω–æ–≤—ã—Ö –∫–æ–Ω—Ñ–∏–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
          }
        } else {
          configError.textContent = result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ';
          configError.style.display = 'block';
        }
      } catch (e) {
        subscriptionLoading.style.display = 'none';
        addSubscriptionBtn.disabled = false;
        configError.textContent = `–û—à–∏–±–∫–∞: ${e.message}`;
        configError.style.display = 'block';
      }
    });

    pasteBtn.addEventListener('click', async () => {
      try {
        const clipboardText = await window.vpn.getClipboard();
        if (clipboardText) {
          configInput.value = clipboardText.trim();
          configInput.focus();
        } else {
          showNotification('–ë—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ –ø—É—Å—Ç', 'error');
        }
      } catch (e) {
        showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'error');
      }
    });


    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞
    ui.serverList && ui.serverList.addEventListener('click', async (event) => {
      const deleteBtn = event.target.closest('[data-action="delete"]');
      if (deleteBtn) {
        const item = deleteBtn.closest('.server-item');
        const id = item.dataset.id;
        const servers = await window.vpn.getServers();
        const server = servers[id];
        if (server && server.configUrl) {
          if (confirm(`–£–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–µ—Ä "${server.name}"?`)) {
            const result = await window.vpn.removeConfig(server.configUrl);
            if (result.success) {
              showNotification('–°–µ—Ä–≤–µ—Ä —É–¥–∞–ª—ë–Ω');
              await loadServers();
            } else {
              showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏', 'error');
            }
          }
        }
        event.stopPropagation();
        return;
      }
    });

    // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    const updateSubscriptionsBtn = document.getElementById('update-subscriptions-btn');
    const testAllBtn = document.getElementById('test-all-btn');
    const blockedTestBtn = document.getElementById('blocked-test-btn');
    const removeDuplicatesBtn = document.getElementById('remove-duplicates-btn');
    const clearAllBtn = document.getElementById('clear-all-btn');

    updateSubscriptionsBtn.addEventListener('click', async () => {
      if (!confirm('–û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏? –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.')) return;
      
      updateSubscriptionsBtn.disabled = true;
      updateSubscriptionsBtn.textContent = '‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
      
      try {
        const result = await window.vpn.updateAllSubscriptions(false);
        showNotification(result.message || `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${result.added} –∫–æ–Ω—Ñ–∏–≥–æ–≤`);
        await loadServers();
      } catch (e) {
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–æ–∫', 'error');
      } finally {
        updateSubscriptionsBtn.disabled = false;
        updateSubscriptionsBtn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏';
      }
    });

    testAllBtn.addEventListener('click', async () => {
      const totalServers = Object.keys(serversCache).length;
      if (totalServers === 0) {
        showNotification('–ù–µ—Ç —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
        return;
      }
      
      if (!confirm(`–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ ${totalServers} –∫–æ–Ω—Ñ–∏–≥–æ–≤? –≠—Ç–æ –∑–∞–π–º–µ—Ç –æ–∫–æ–ª–æ ${Math.ceil(totalServers / 15 * 2.5)} —Å–µ–∫—É–Ω–¥.`)) return;
      
      testAllBtn.disabled = true;
      const startTime = Date.now();
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
      const updateProgress = () => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        testAllBtn.textContent = `‚è≥ ${elapsed}—Å...`;
      };
      const progressInterval = setInterval(updateProgress, 500);
      updateProgress();
      
      try {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        const selectedConfigUrl = selectedId && serversCache[selectedId] ? serversCache[selectedId].configUrl : null;
        
        const results = await window.vpn.testAllConfigs();
        clearInterval(progressInterval);
        
        await loadServers(results);
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±–æ—Ä –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        if (selectedConfigUrl) {
          for (const [id, server] of Object.entries(serversCache)) {
            if (server.configUrl === selectedConfigUrl) {
              setSelected(id);
              break;
            }
          }
        }
        
        const successCount = results.filter(r => r.success).length;
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        showNotification(`–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${successCount}/${results.length} –¥–æ—Å—Ç—É–ø–Ω—ã –∑–∞ ${elapsed}—Å`);
      } catch (e) {
        clearInterval(progressInterval);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏', 'error');
      } finally {
        testAllBtn.disabled = false;
        testAllBtn.textContent = '‚ö° –¢–µ—Å—Ç';
      }
    });

    blockedTestBtn.addEventListener('click', async () => {
      if (!isConnected) {
        showNotification('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
        return;
      }

      blockedTestBtn.disabled = true;
      blockedTestBtn.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';

      try {
        const result = await window.vpn.testBlockedSites();
        if (!result.success) {
          showNotification(result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø', 'error');
        } else {
          const summary = result.results.map(r => `${r.success ? '‚úÖ' : '‚ùå'} ${r.name}`).join(', ');
          const type = result.reachable === result.results.length ? 'success' : 'error';
          showNotification(`–î–æ—Å—Ç—É–ø: ${summary}`, type);
        }
      } catch (e) {
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–∞–π—Ç–æ–≤', 'error');
      } finally {
        blockedTestBtn.disabled = false;
        blockedTestBtn.textContent = 'üõ° –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏';
      }
    });

    removeDuplicatesBtn.addEventListener('click', async () => {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –∫–æ–Ω—Ñ–∏–≥–∏?')) return;
      
      try {
        const result = await window.vpn.removeDuplicates();
        if (result.removed > 0) {
          showNotification(`–£–¥–∞–ª–µ–Ω–æ ${result.removed} –¥—É–±–ª–∏–∫–∞—Ç–æ–≤`);
          await loadServers();
        } else {
          showNotification('–î—É–±–ª–∏–∫–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
        }
      } catch (e) {
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤', 'error');
      }
    });

    clearAllBtn.addEventListener('click', async () => {
      if (!confirm('–£–î–ê–õ–ò–¢–¨ –í–°–ï –ö–û–ù–§–ò–ì–ò? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) return;
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í—Å–µ –∫–æ–Ω—Ñ–∏–≥–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!')) return;
      
      try {
        await window.vpn.clearAllConfigs();
        showNotification('–í—Å–µ –∫–æ–Ω—Ñ–∏–≥–∏ —É–¥–∞–ª–µ–Ω—ã');
        await loadServers();
      } catch (e) {
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏', 'error');
      }
    });

    async function init() { pinnedId = await window.vpn.getPinned(); renderPinned(); await loadServers(); resetSpeed(); }
    init(); setInterval(loadServers, 300000);
  </script>
</body>
</html>